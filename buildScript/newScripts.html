######
### IMPORTANT !!!!!
### THIS IS THE JS SCRIPT YOU NEED TO ADD TO SCHOOL BOX -> ADMINISTRATION -> SYSTEM SETTINGS -> SITE -> Custom JavaScript
### without doing this first, none of the custom script will run.

<script>
  const BASE_URL = 'https://appdev.mentonegirls.vic.edu.au';

  const initHtml = () => {
    const iFrame = document.querySelector('iframe#remote');
    if (iFrame) {
      iFrame.style.display = 'none';
      const reactDiv = document.createElement("div");
      reactDiv.setAttribute('id', 'mgg-root');
      reactDiv.setAttribute('data-url', `${iFrame.src || ''}`);
      if(iFrame.nextSibling){
        iFrame.parentNode.insertBefore(reactDiv, iFrame.nextSibling);
      } else{
        iFrame.parentNode.appendChild(reactDiv);
      }
      return true;
    }
    return false;
  }

  const renderFrame = (mainJsUrl, mainCssUrl, loadCss = false) =>  {
    const header = document.getElementsByTagName('head')[0];

    const meta = document.createElement('meta');
    meta.name = "viewport";
    meta.content = "width=device-width,initial-scale=1";
    header.appendChild(meta);

    const manifest = document.createElement('link');
    manifest.ref = "manifest";
    manifest.href = `${BASE_URL}/manifest.json`;
    header.appendChild(manifest);

    if (loadCss === true) {
        const mainCss = document.createElement('link');
        mainCss.rel = "stylesheet";
        mainCss.type = "text/css";
        mainCss.href = `${BASE_URL}${mainCssUrl}`;
        header.appendChild(mainCss);
    }

    const mainJs = document.createElement('script');
    mainJs.defer = "defer";
    mainJs.src = `${BASE_URL}${mainJsUrl}`;
    document.body.appendChild(mainJs);
  }

  const fetchData = function(url, callback) {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', url, false);
    // xhr.responseType = 'json';
    xhr.onload = function() {
      const status = xhr.status;
      callback(status, xhr.response);
    };
    xhr.send(null);
  };

  const run = function() {
    const htmlInitiated = initHtml();
    // if (htmlInitiated !== true) {
    //   console.log('not a iframe page');
    //   return;
    // }
    fetchData(`${BASE_URL}/asset-manifest.json`, (status, response) => {
      if (status !== 200) {
        return null;
      }
      try {

          const responseObj = JSON.parse(response);
          if (responseObj.files) {
            const mainJsString = `${responseObj.files['main.js']}`.trim();
            const mainCssString = `${responseObj.files['main.css']}`.trim();
            // initHtml();
            renderFrame(mainJsString, mainCssString, htmlInitiated);
          }
      } catch (err) {
        console.error(err);
      }
    })
  }

  window.onload = function() {
    run();
  }

</script>
